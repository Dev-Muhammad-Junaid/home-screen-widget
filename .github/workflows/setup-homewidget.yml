name: Setup iOS HomeWidget Files

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'ios/**'
      - 'lib/**'
      - '.github/workflows/setup-homewidget.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'ios/**'
      - 'lib/**'

jobs:
  setup-homewidget:
    name: Setup iOS HomeWidget Files
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Make setup script executable
      run: chmod +x scripts/setup_homewidget_ios.sh
    
    - name: Run HomeWidget setup script
      run: ./scripts/setup_homewidget_ios.sh
    
    - name: Check for changes
      id: verify-changed-files
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "Files were created/modified:"
          git status --porcelain
        else
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "No changes detected"
        fi
    
    - name: Commit and push changes
      if: steps.verify-changed-files.outputs.changed == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add ios/
        git commit -m "🤖 Auto-setup iOS HomeWidget files

        - Created/updated entitlements files
        - Created/updated HomeWidget Swift files
        - Created/updated Assets.xcassets
        - Ensured proper App Group configuration
        
        Generated by: .github/workflows/setup-homewidget.yml"
        git push
    
    - name: Create summary
      if: steps.verify-changed-files.outputs.changed == 'true'
      run: |
        echo "## 🎉 iOS HomeWidget Setup Complete!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Files Created/Updated:" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ iOS entitlements files" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ HomeWidget Swift implementation" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Assets.xcassets structure" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ App Group ID configuration" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
        echo "1. Open your iOS project in Xcode" >> $GITHUB_STEP_SUMMARY
        echo "2. Add the HomeWidget target if needed" >> $GITHUB_STEP_SUMMARY
        echo "3. Configure signing & capabilities" >> $GITHUB_STEP_SUMMARY
        echo "4. Build and test your widget!" >> $GITHUB_STEP_SUMMARY

  # Optional: Run on schedule to ensure files stay in place
  scheduled-check:
    name: Scheduled HomeWidget Check
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Check for missing HomeWidget files
      run: |
        missing_files=()
        
        # Check critical files
        [ ! -f "ios/Runner/Runner.entitlements" ] && missing_files+=("Runner.entitlements")
        [ ! -f "ios/HomeWidget/HomeWidget.swift" ] && missing_files+=("HomeWidget.swift")
        [ ! -f "ios/HomeWidget/Info.plist" ] && missing_files+=("HomeWidget Info.plist")
        
        if [ ${#missing_files[@]} -gt 0 ]; then
          echo "❌ Missing HomeWidget files detected:"
          printf '%s\n' "${missing_files[@]}"
          echo "missing=true" >> $GITHUB_ENV
        else
          echo "✅ All HomeWidget files present"
          echo "missing=false" >> $GITHUB_ENV
        fi
    
    - name: Recreate missing files
      if: env.missing == 'true'
      run: |
        chmod +x scripts/setup_homewidget_ios.sh
        ./scripts/setup_homewidget_ios.sh
        
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action [Scheduled]"
        git add ios/
        git commit -m "🔧 Auto-restore missing iOS HomeWidget files [Scheduled]"
        git push 
